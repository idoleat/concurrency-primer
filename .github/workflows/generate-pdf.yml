name: Generate pdf release
on:
  push:
    branches:
      - mdbook

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install latest mdbook
        run: |
          tag=$(curl 'https://api.github.com/repos/rust-lang/mdbook/releases/latest' | jq -r '.tag_name')
          url="https://github.com/rust-lang/mdbook/releases/download/${tag}/mdbook-${tag}-x86_64-unknown-linux-gnu.tar.gz"
          mkdir mdbook
          curl -sSL $url | tar -xz --directory=./mdbook
          echo `pwd`/mdbook >> $GITHUB_PATH
      - name: Install latest mdbook-pdf and mdbook-pdf-outline
        run: |
          tag=$(curl 'https://api.github.com/repos/HollowMan6/mdbook-pdf/releases/latest' | jq -r '.tag_name')
          url="https://github.com/HollowMan6/mdbook-pdf/releases/download/${tag}/mdbook-pdf-${tag}-x86_64-unknown-linux-gnu"
          mkdir mdbook-pdf
          curl --output-dir "mdbook-pdf" --output mdbook-pdf -sSL $url
          chmod +x ./mdbook-pdf/*
          echo `pwd`/mdbook-pdf >> $GITHUB_PATH
          pip install mdbook-pdf-outline
      - name: Enable pdf ouput
        run: |
          echo "" >> book.toml
          echo "[output.pdf]" >> book.toml
          echo "display-header-footer = false" >> book.toml
          echo "scale = 0.8" >> book.toml
          echo "paper-width = 8" >> book.toml
          echo "paper-height = 10" >> book.toml
          echo "margin-top = 0.5" >> book.toml
          echo "margin-bottom = 0.5" >> book.toml
          echo "margin-left = 0.1" >> book.toml
          echo "margin-right = 0.1" >> book.toml
          echo "" >> book.toml
          echo "[output.pdf-outline]" >> book.toml
      - name: Build Book
        run: |
          # This assumes your book is in the root of your repository.
          # Just add a `cd` here if you need to change to another directory.
          mdbook build
      - name: Change pdf named
        run: |
          mv book/pdf-outline/output.pdf ./concurrency-primer.pdf
      - name: Delete old release
        uses: cb80/delrel@latest
        with:
          tag: mdbook-pdf
      - name: Create and Upload Release
        id: release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            ./concurrency-primer.pdf
          tag_name: "mdbook-pdf"
          body: |
            This is an experimetal pdf build generated by print-to-pdf. Any style, arrangement and content may change.
